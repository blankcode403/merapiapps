<?php/** * User model * table name 'users' **/class Users_model extends RAR_Model{public $table;public $data;	public function __CONSTRUCT(){		$this->table = array(			'mst_users' => $this->db->dbprefix('mst_users'),		);		parent::__CONSTRUCT();	}	/**	 * Get data information user account	 * @param $index string	 * @param $param string (optional) attribute from table users default 'email'	 * @return array	 **/	public function getData($index = null,$param = 'username'){		$query = $this->db->get_where($this->table['mst_users'],array($param => $index),1);		if($query->num_rows() > 0){			$data = $query->result_array();			$this->data = $data[0];			return $this->data;		}		else{ return array();}	}	/**	 * Login user function	 * @param $data array([username], [password])	 * @return none	 **/	public function login($data = array()){		if($this->getData($data['username'])){			if($this->data['passwd'] == $data['passwd'])			{				if(!$this->isConnected($this->data['connected'])){					if($this->data['error_login'] <= $this->config->item('wrong_password') AND $this->data['status'] == '1')					{						$this->db->where(array('username'=>$this->data['username']));						$this->db->update($this->table['mst_users'],array(							'ipaddress'	=> $_SERVER['REMOTE_ADDR'],							'last_login'	=> date(),							'error_login' => 0,						));					}					else{$this->error->set($this->error_lang['user_block']);}				}				else{$this->error->set('('.$data['username'].') '.$this->error_lang['was_login'].' IP :'.$this->data['ipaddress']);}			}			else{				$this->db->where(array('username'=>$this->data['username']));				$this->db->update($this->table['mst_users'],array('error_login' => $this->data['error_login']+1));				$this->error->set($this->error_lang['wrong_pass']);			}		}		else{			$this->error->set($this->error_lang['not_register']);		}		if(!$this->error->isError()){			$this->session->set_userdata(array(								'id_user'	=> $this->data['id_user'],				'username' => $this->data['username'],				'name_alias' => $this->data['name_alias'],				'passwd'	=> $this->data['passwd'],				'group_id'	=> $this->data['group_id'],				'branch'	=> $this->data['branch'],				'status' => $this->data['status']			));		}	}	/**	 * Check user is login	 * @return booelan	 */	public function isLogin(){		$session = $this->session->all_userdata();		if(isset($session['id_user']) and isset($session['id_user'])){			return true;		}		else{$this->error->set($this->error_lang['not_login']);}	}	/**	 * Reset count fail login user	 * @param $email string	 * @return array	 */	public function resetErrorLogin($user_id){		$this->db->where(array('user_id'=>$user_id));		return $this->db->update($this->table['mst_users'],array('error_login' => 0));	}	/**	 * time connected email	 * @param $email	 * @return none	 */	public function ping(){		$this->db->where('user_id',$this->session->userdata('userid'));		$this->db->update($this->table['user'],array('connected' => date()));	}	/**	 * Check user are connected	 * @param $time	 * @return booelan	 **/	public function isConnected($time){		if(!empty($time) AND time() <= ($time+$this->config->item('user_delay_ping'))){	return true;}	}}?>